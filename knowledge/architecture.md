## 架构与模块

#### 整体结构与详细工作流

基于 Reactor 的半同步/半异步并发模式 + 同步 epoll (ET) 事件循环 + 多线程 (线程池)

![](../plantuml/workflow.png)

----

### 各大模块


#### 1. Epoll 事件循环

在整体架构中，epoll 属于同步的部分，由主线程同步运行。

- **结构**

1. ET 模式。

2. 注册的事件类型: （1）新连接请求到来（2）连接socket上读就绪（3）连接socket上写就绪

3. 只负责接受连接，分发读取/写出任务，以及定时器超时任务。

4. 定期处理超时事件: 目前每5秒。

#### 2. 时间堆

- **结构**

1. 采用自实现的最小堆，存放定时器的指针。

2. 每次处理时不断从顶部取出定时器，并判断是否超时。

3. 删除定时器采用懒惰删除，给定时器打上 cancled 标签。

#### 3. 线程池

- **结构**

1. **半同步/半反应堆模式**，工作队列(**同步**)负责任务获取与分发，工作线程(**异步**)负责处理任务。

2. 工作队列: list<pair<T*, int>>，每个任务包含结构体和一个标签 flag，用于标记 READ/WRITE 任务。

3. 工作线程: shared_ptr<pthread_t> threads，线程线程标识符数组，预分配大小。

- **优点**

1. 以空间换取时间效率。

2. 线程池适用于高并发多线程，但每个线程运行时间较短的情况。

3. 通用性高，比较 general，采用模板元编程。

- **限制**

1. 要求客户请求都是无状态的，同一个连接上的不同请求可能由不同的线程处理。

2. 容易产生惊群效应，需要特殊处理。

#### 3. 工作线程

1. 工作线程取出读取/写出任务后，回调 HTTP 连接类的 process() 函数。

2. 回调一次 process() 函数负责:

（1）从内核缓冲区读取数据到用户缓冲区: 非阻塞 read，(遇到 EAGAIN 则返回)

（2）处理 HTTP 请求报文

（3）构建 HTTP 响应报文

（4）把响应报文写入到内核缓冲区: 非阻塞 write，（遇到 EAGAIN 则返回）

3. **如果能一次性处理完则不再通知 epoll**
