## 基础知识

---

#### 服务器并发模式分析

**1. 单进程多线程模式**

通过在单进程内创建线程池，使工作线程异步并行地为客户的请求服务。

**优点：**

（1）工作线程之间数据共享方便（全局、静态变量）。

（2）线程的上下文切换开销较小（不切换地址空间，不刷新 TLB，只修改部分 CPU 寄存器），善于处理高并发。

（3）线程创建速度较快。

**缺点：**

（1）一个线程挂了，其他线程也就挂了。（虽然能写守护进程来重启，但是会有宕机期。）

（2）编程时需要考虑资源的同步问题，稍显复杂。

**2. 多进程单线程模式**

**优点：**

（1）一个进程崩溃可以被 master 重启，并不会使整个服务器挂掉。因此 master 安全隔离了工作进程。

（2）数据隔离和错误隔离。

（3）编程相对简单，通常不同考虑资源同步的问题。

**缺点：**

（1）进程切换开销大，对高并发的处理能力不如多线程模式。

**3. 多进程多线程模式**

在每个子进程内开多个线程。在支持高并发的情况下，避免了单进程多线程的宕机问题。

**4. Pink server 的模式**

目前的 Pink 为单进程多线程模式（更像单进程版的 Apache event MPM 模式）。实现这个模式一是为了熟悉多线程编程、资源同步方式，二是觉得从多线程到多进程的过度相对容易。（下一个 server 实现多进程。）

---

#### 主流的 Web 服务器分析

**1. Apache**

Apache 有三种稳定的 MPM（multi-processing module），即多进程处理模块。分别是 prefork、worker和 event。

（1）prefork（Linux 下的默认模式）

很古老但十分稳定。通过预先 fork 一些子进程等待请求。一个子进程一个线程，处理一个请求。

优点：不需要考虑线程安全问题。成熟稳定。

缺点：子进程数量有上限，不能 handle 高并发的情况。进程的内存开销大。

（2）worker

在 prefork 的基础上，每个子进程中创建多个线程。（这里使用多进程是为了服务器的稳定性。）

优点：高并发下比 prefork 更优秀，占据更少内存。

缺点：由于用了多线程，则需要考虑线程安全问题。

（3）event

把工作线程和连接分离开来，从而解决 keep-alive 连接总是占据一个工作线程的问题。以事件的形式触发线程。（基于 linux epoll）

优点：处理了 keep-alive 连接的情况。更高的并发量。事件驱动使得更适合于 IO 密集型服务。

缺点：对于 HTTPS 连接，仍然是类似 worker 模式，线程会一直被占用的。

**2. NginX**

参考1：https://www.jianshu.com/p/a253d21e4b16

参考2（阿里云天基blog）：http://tengine.taobao.org/book/#id4

轻量级的异步非阻塞高性能 HTTP/ 反向代理 服务器。

优点：

（1）轻量级，比 apache 占用更少的内存资源。

（2）高度模块化的设计。

（3）性能强大，静态处理性能比 apache 高三倍以上。

---

#### HTTP Web 服务器基础概念

![](../imgs/http_web_server.png)

（1）建立连接

（2）接收请求（从网络中读取HTTP请求报文）

（3）处理请求（对请求报文进行解释，并采取行动）

（4）访问资源（访问报文中指定的资源）

（5）构建响应（创建带有正确首部的HTTP响应报文）

（6）发送响应（将响应回送给客户端）

（7）记录事务处理过程（将与已完成事务有关的内容记录在一个日志文件中）
